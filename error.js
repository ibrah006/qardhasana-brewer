Uncaught TypeError: "\n    // Authentication state\n    let currentUser = null;\n    let authToken = null;\n    const TOKEN_KEY = 'qardhasana_widget_token';\n    let authState = 'not_logged_in'; // 'not_logged_in', 'entering_email', 'entering_otp', 'logged_in'\n    let pendingEmail = null;\n\n    // Check for existing session on load\n    async function checkExistingSession() {\n      const token = localStorage.getItem(TOKEN_KEY);\n      if (!token) return;\n\n      try {\n        const response = await fetch('https://qardhasana.com/_api/widget/auth/session', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ token }),\n        });\n\n        const text = await response.text();\n        let data;\n        try {\n          const parsed = JSON.parse(text);\n          data = parsed.json || parsed;\n        } catch (e) {\n          throw new Error('Invalid response format');\n        }\n\n        if (response.ok && data.success) {\n          authToken = token;\n          currentUser = data.user;\n          authState = 'logged_in';\n          updateAuthUI();\n        } else {\n          // Invalid token, clear it\n          localStorage.removeItem(TOKEN_KEY);\n        }\n      } catch (error) {\n        console.error('Session validation error:', error);\n        localStorage.removeItem(TOKEN_KEY);\n      }\n    }\n\n    // Update authentication UI\n    function updateAuthUI() {\n      const authSection = document.getElementById('auth-section');\n      const signInPrompt = document.getElementById('sign-in-prompt');\n      const emailForm = document.getElementById('email-form');\n      const otpForm = document.getElementById('otp-form');\n      const loggedInState = document.getElementById('logged-in-state');\n      \n      // Hide all auth UI elements first\n      signInPrompt.style.display = 'none';\n      emailForm.style.display = 'none';\n      otpForm.style.display = 'none';\n      loggedInState.style.display = 'none';\n\n      if (authState === 'not_logged_in') {\n        signInPrompt.style.display = 'flex';\n      } else if (authState === 'entering_email') {\n        emailForm.style.display = 'block';\n      } else if (authState === 'entering_otp') {\n        otpForm.style.display = 'block';\n        document.getElementById('otp-email-display').textContent = pendingEmail;\n      } else if (authState === 'logged_in') {\n        loggedInState.style.display = 'flex';\n        document.getElementById('user-email-display').textContent = currentUser.email;\n      }\n    }\n\n    // Show sign-in form\n    function showSignInForm() {\n      authState = 'entering_email';\n      updateAuthUI();\n    }\n\n    // Handle email submission\n    async function handleEmailSubmit(e) {\n      e.preventDefault();\n      const emailInput = document.getElementById('email-input');\n      const email = emailInput.value.trim();\n      const submitBtn = document.getElementById('email-submit-btn');\n      const errorDiv = document.getElementById('email-error');\n\n      if (!email) return;\n\n      submitBtn.disabled = true;\n      submitBtn.textContent = 'Sending...';\n      errorDiv.style.display = 'none';\n\n      try {\n        const response = await fetch('https://qardhasana.com/_api/widget/auth/login', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ email }),\n        });\n\n        const text = await response.text();\n        let data;\n        try {\n          const parsed = JSON.parse(text);\n          data = parsed.json || parsed;\n        } catch (e) {\n          throw new Error('Invalid response format');\n        }\n\n        if (response.ok && data.success) {\n          pendingEmail = email;\n          authState = 'entering_otp';\n          updateAuthUI();\n          \n          // For testing: log the OTP if provided\n          if (data.otpForTesting) {\n            console.log('Test OTP:', data.otpForTesting);\n          }\n        } else {\n          throw new Error(data.message || 'Failed to send code');\n        }\n      } catch (error) {\n        console.error('Email submission error:', error);\n        errorDiv.textContent = error.message || 'Failed to send code. Please try again.';\n        errorDiv.style.display = 'block';\n      } finally {\n        submitBtn.disabled = false;\n        submitBtn.textContent = 'Send Code';\n      }\n    }\n\n    // Handle OTP submission\n    async function handleOtpSubmit(e) {\n      e.preventDefault();\n      const otpInput = document.getElementById('otp-input');\n      const otp = otpInput.value.trim();\n      const submitBtn = document.getElementById('otp-submit-btn');\n      const errorDiv = document.getElementById('otp-error');\n\n      if (!otp || otp.length !== 6) {\n        errorDiv.textContent = 'Please enter a valid 6-digit code';\n        errorDiv.style.display = 'block';\n        return;\n      }\n\n      submitBtn.disabled = true;\n      submitBtn.textContent = 'Verifying...';\n      errorDiv.style.display = 'none';\n\n      try {\n        const response = await fetch('https://qardhasana.com/_api/widget/auth/verify', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ email: pendingEmail, otp }),\n        });\n\n        const text = await response.text();\n        let data;\n        try {\n          const parsed = JSON.parse(text);\n          data = parsed.json || parsed;\n        } catch (e) {\n          throw new Error('Invalid response format');\n        }\n\n        if (response.ok && data.success) {\n          authToken = data.token;\n          currentUser = data.user;\n          localStorage.setItem(TOKEN_KEY, authToken);\n          authState = 'logged_in';\n          updateAuthUI();\n          \n          // Clear forms\n          document.getElementById('email-form').reset();\n          document.getElementById('otp-form').reset();\n        } else {\n          throw new Error(data.message || 'Invalid code');\n        }\n      } catch (error) {\n        console.error('OTP verification error:', error);\n        errorDiv.textContent = error.message || 'Invalid code. Please try again.';\n        errorDiv.style.display = 'block';\n      } finally {\n        submitBtn.disabled = false;\n        submitBtn.textContent = 'Verify';\n      }\n    }\n\n    // Handle resend code\n    async function handleResendCode() {\n      const resendBtn = document.getElementById('resend-code-btn');\n      const errorDiv = document.getElementById('otp-error');\n      \n      resendBtn.disabled = true;\n      const originalText = resendBtn.textContent;\n      resendBtn.textContent = 'Sending...';\n      errorDiv.style.display = 'none';\n\n      try {\n        const response = await fetch('https://qardhasana.com/_api/widget/auth/login', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ email: pendingEmail }),\n        });\n\n        const text = await response.text();\n        let data;\n        try {\n          const parsed = JSON.parse(text);\n          data = parsed.json || parsed;\n        } catch (e) {\n          throw new Error('Invalid response format');\n        }\n\n        if (response.ok && data.success) {\n          const successDiv = document.createElement('div');\n          successDiv.className = 'auth-success';\n          successDiv.textContent = 'Code sent! Check your email.';\n          document.getElementById('otp-form').prepend(successDiv);\n          setTimeout(() => successDiv.remove(), 3000);\n          \n          // For testing: log the OTP if provided\n          if (data.otpForTesting) {\n            console.log('Test OTP:', data.otpForTesting);\n          }\n        } else {\n          throw new Error(data.message || 'Failed to resend code');\n        }\n      } catch (error) {\n        console.error('Resend error:', error);\n        errorDiv.textContent = error.message || 'Failed to resend code. Please try again.';\n        errorDiv.style.display = 'block';\n      } finally {\n        resendBtn.disabled = false;\n        resendBtn.textContent = originalText;\n      }\n    }\n\n    // Handle sign out\n    function handleSignOut() {\n      localStorage.removeItem(TOKEN_KEY);\n      authToken = null;\n      currentUser = null;\n      authState = 'not_logged_in';\n      updateAuthUI();\n    }\n\n    // Cancel auth flow\n    function cancelAuthFlow() {\n      authState = 'not_logged_in';\n      pendingEmail = null;\n      document.getElementById('email-form').reset();\n      document.getElementById('otp-form').reset();\n      document.getElementById('email-error').style.display = 'none';\n      document.getElementById('otp-error').style.display = 'none';\n      updateAuthUI();\n    }\n" is not a function